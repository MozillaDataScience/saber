---
title: '`r rjson::fromJSON(file="experiment.json")$report_title`'
author: '`r rjson::fromJSON(file="experiment.json")$author`'
date: 'Last Updated: `r format(Sys.time(), "%B %d, %Y")`'
output:
  html_document:
    theme: cosmo
    toc: true
    toc_float: true
---

```{R, include=F}
# load functions and packages
source("../../r_utils/funcs.R")
spec <- rjson::fromJSON(file="experiment.json")
knitr::opts_chunk$set(echo=F, warning=F, message=F)
packages <- c("bigrquery", "ggplot2", "DBI", "data.table",
              "reshape2", "DT", "GetoptLong", "readr", "rjson")
ipak(packages)

# read in data
result_capped <- fread("cat ./data/capped.csv")[,.(Metric=variable, `Percent Change`=change, lower, upper)]
result_tail_capped <- fread("cat ./data/capped_tail.csv")[,.(Metric=variable, bucket=level_1, `Percent Change`=change, lower, upper)]
result_decile_capped <- fread("cat ./data/capped_decile.csv")[,.(Metric=variable, bucket=level_1, `Percent Change`=change, lower, upper)]
exp_branch <- fread("cat ./data/branch_day.csv")


summary_capped <- create_summary(result_capped, 0.01)
summary_tail_capped <- create_summary(result_tail_capped, 0.01)
summary_decile_capped <- create_summary(result_decile_capped, 0.01)

exp_melted <- melt(exp_branch, id.vars = c('experiment_branch', 'submission_date'))
exp_melted$submission_date <- as.Date(exp_melted$submission_date, format="%Y-%m-%d")
```



# {.tabset}

This is an experiment report for the ``r spec$experiment_slug`` study.

## Executive Summary

### TL;DR

 __What were the main takeaways?__

### Introduction

__Why did we run this study?__

### Data

This experiment launched on `r spec$start`
and ended on `r spec$end`.
It targeted `r spec$target_percent` of Firefox users
on the `r spec$channels` channel with
version `r spec$versions`. It further only targetted users with an `en-US` locale and `US` country.


`r format(fread("cat ./data/n_clients.txt")[[1]], big.mark = ",")` users were enrolled in this experiment.


### Results

__What were the results? Paste relevent charts/tables from the Detailed Summary tab if necessary__

### Conclusion

__How do the results inform a decision?__


## Detailed Summary

This section contains "all the things", and lacks any detailed prose. We use the contents of this section to spot check any results, however not all charts / tables are essential to the findings.

#### Experiment Population

<center>

```{r}
plot_enrollment_by_day()
```

</center>

#### Overall Percent Changes For All Metrics



<div class="row">
<div class = "col-md-6">

```{r}
render_pct_change_table(metrics="*", summary_capped)
```


</div>
<div class = "col-md-6">


```{r, echo=FALSE, fig.height=6.2, fig.width=5, warning=F}
plot_pct_changes(metrics="*", s=summary_capped)
```
</div>
</div>

```{r}

plot_pct_changes_bucket <- function(s, metric='sap') {
  s <- s[Metric==metric]
  s$bucket <- factor(s$bucket)
  s$color <- factor(ifelse(s$`Percent Change` == 0, 1, s$color))
  sig_pct <- s[,.(pct=mean(ifelse(color!=1, 1, 0))), bucket]
  s$color <- factor(s$color)
  tlabel = "% showed changes"
  s <- merge(s, sig_pct, by="bucket")
  ggplot(s, aes(x=bucket, y=`Percent Change`, colour=color)) +
    geom_point(size=2, position=position_dodge(width=0.2), alpha=.5) +
    geom_errorbar(aes(ymin=lower, 
                      ymax=upper), 
                  width = .2, position = 'dodge', alpha=.5) +
     theme_bw() + theme(legend.position="bottom", 
                                                  legend.title=element_blank()) +
    xlab("") + ylab("% Change") + coord_flip() +
    labs(title=paste('Percent Change Estimates:', metric),
         subtitle="(Treatment - Control), with 99% CIs") +
    geom_hline(yintercept = 0, linetype=2) +
    scale_y_continuous(labels = scales::percent, limits = c(-.1, .1)) +
    scale_color_manual(values=c("0"='#008000', "1"='grey', "2"='#ff2e2e'), labels=c("0"="Positive Change", '1'="No Change", '2'="Negative Change"))
}

```


#### Decile % Changes (left) and Upper Tail % Changes (right)

<center>

<div class="row">
<div class = "col-md-6">

```{r, echo=FALSE, fig.height=4.5, fig.width=5, warning=F}
plot_pct_changes_bucket(summary_decile_capped, metric='sap')
```


</div>
<div class = "col-md-6">

```{r, echo=FALSE, fig.height=4.5, fig.width=5, warning=F}
plot_pct_changes_bucket(summary_tail_capped, metric='sap')
```


</div>
</div>

</center>

<center>

<div class="row">
<div class = "col-md-6">

```{r, echo=FALSE, fig.height=4.5, fig.width=5, warning=F}
plot_pct_changes_bucket(summary_decile_capped, metric='tagged_sap')
```


</div>
<div class = "col-md-6">

```{r, echo=FALSE, fig.height=4.5, fig.width=5, warning=F}
plot_pct_changes_bucket(summary_tail_capped, metric='tagged_sap')
```


</div>
</div>

</center>


<center>

<div class="row">
<div class = "col-md-6">

```{r, echo=FALSE, fig.height=4.5, fig.width=5, warning=F}
plot_pct_changes_bucket(summary_decile_capped, metric='organic')
```


</div>
<div class = "col-md-6">

```{r, echo=FALSE, fig.height=4.5, fig.width=5, warning=F}
plot_pct_changes_bucket(summary_tail_capped, metric='organic')
```


</div>
</div>

</center>

<center>

<div class="row">
<div class = "col-md-6">

```{r, echo=FALSE, fig.height=4.5, fig.width=5, warning=F}
plot_pct_changes_bucket(summary_decile_capped, metric='ad_clicks')
```


</div>
<div class = "col-md-6">

```{r, echo=FALSE, fig.height=4.5, fig.width=5, warning=F}
plot_pct_changes_bucket(summary_tail_capped, metric='ad_clicks')
```


</div>
</div>

</center>

Metrics over time. These charts are unfiltered, in that they include outliers. 


```{r, fig.width=20, fig.height=6, warning=F}
plot_metrics_by_day()
```






